let liveData=!1;const renderEl=document.body.appendChild(renderer.domElement);$("#info").hide(),$("#earth").hide(),latLongDefault||displayLatLong(latitude,longitude);function animate(a){let b=1/clock.getDelta();if(fpsBuffer.push(b),7<fpsBuffer.length){let a=0;for(let b=0;b<fpsBuffer.length;b++)a+=fpsBuffer[b];avgFPS=a/fpsBuffer.length,fpsBuffer=[],liveData=!0}rate=rates[speed]*(fps/b),ephTime+=rate,sun.rotateOnAxis(new THREE.Vector3(0,1,0),sun.thetaDot*rate);let c=ephTimeReadout(ephTime).a;c+=speed>pauseRate-4&&speed<pauseRate+4?ephTimeReadout(ephTime).b:"",c+=speed>pauseRate-2&&speed<pauseRate+2?ephTimeReadout(ephTime).c:"",c+=speed>pauseRate-4&&speed<pauseRate+4?ephTimeReadout(ephTime).d:"",$("#date").html(c),$("#speed").html(rateDesc[speed]),$("#fps").html(avgFPS.toFixed(2)),extraData?($(".extraData").show(),$("#mjd").html(ephTimeToMJD(ephTime).toFixed(3)),$("#lst").html(localSiderealTime(ephTime).toFixed(3))):$(".extraData").hide();for(let b=0;b<precessing.length;b++)system[precessing[b]].precess(rate),redraw(b);for(let b=0;b<system.length;b++){system[b].update(rate);const a=scene.children[system[b].childId];a.position.x=system[b].celestialPos.x,a.position.y=system[b].celestialPos.y,a.position.z=system[b].celestialPos.z,a.rotateOnAxis(new THREE.Vector3(0,1,0),system[b].thetaDot*rate),system[b].toSun=system[b].celestialPos.length(),system[b].toEarth=system[b].celestialPos.clone().sub(system[earthID].celestialPos);const c=$("#"+b),e=new THREE.Vector3().setFromMatrixPosition(a.matrixWorld).project(camera);if(e.x=e.x*centerX+centerX,e.y=-1*(e.y*centerY)+centerY,c.length)Math.abs(e.x-centerX)<centerX&&Math.abs(e.y-centerY)<centerY&&1>e.z?c.css({left:e.x+10,top:e.y-5,visibility:"visible"}):c.css({visibility:"hidden"});else{const a=e.distanceTo(mousePos);15>a&&(makeLabel(b),tempLabels.push(b))}if(4<tempLabels.length){const a=$("#"+tempLabels.shift());a.hasClass("active")||a.remove()}}if(graticule.visible){$(".gratLabel").show();for(let a=0;a<gratLabels.length;a++){const b=gratLabels[a].label,c=new THREE.Vector3(gratLabels[a].x,gratLabels[a].y,gratLabels[a].z).add(camera.position);c.project(camera),c.x=c.x*centerX+centerX,c.y=-1*(c.y*centerY)+centerY,Math.abs(c.x-centerX)<centerX&&Math.abs(c.y-centerY)<centerY&&1>c.z?b.css({left:c.x-20,top:c.y-5,visibility:"visible"}):b.css({visibility:"hidden"})}}else $(".gratLabel").hide();for(let b=0;b<moons.length;b++)paths[moons[b].path].position.x=system[paths[moons[b].path].orbitId].celestialPos.x,paths[moons[b].path].position.y=system[paths[moons[b].path].orbitId].celestialPos.y,paths[moons[b].path].position.z=system[paths[moons[b].path].orbitId].celestialPos.z;system[earthID].baryPos=system[earthID].celestialPos.clone().sub(system[moonID].celestialPos).multiplyScalar(earthBary);const d=scene.children[system[earthID].childId];d.position.x+=system[earthID].baryPos.x,d.position.y+=system[earthID].baryPos.y,d.position.z+=system[earthID].baryPos.z;const e=system[plutoID].celestialPos.clone().sub(system[charonID].celestialPos).multiplyScalar(plutoBary),f=scene.children[system[plutoID].childId];if(f.position.x+=e.x,f.position.y+=e.y,f.position.z+=e.z,""!=clickedLabel){const a=getRA(clickedPlanet),b=altAz(a.ra,a.dec,ephTime),c=180-clickedPlanet.toEarth.angleTo(system[earthID].celestialPos)*toDeg;if(liveData){if("undefined"==typeof clickedPlanet.orbitId)$("#orbitVel").html(visViva(sunGravConstant,clickedPlanet.toSun,clickedPlanet.semiMajorAxis).toFixed(3));else{const a=clickedPlanet.celestialPos.clone().sub(system[clickedPlanet.orbitId].celestialPos).length();$("#orbitVel").html(visViva(system[clickedPlanet.orbitId].mass*gravConstant,a,clickedPlanet.semiMajorAxis).toFixed(3))}const d=apparentMag(clickedPlanet);let e="";if(0<b.alt){const a=extinction(d,b.alt);e="<br>("+a.mag.toFixed(2)+" under "+a.airmass.toFixed(2)+" airmasses)"}$("#appMag").html(d.toFixed(2)+e),$("#toSun, #earthToSun").html(clickedPlanet.toSun.toFixed(4)),$("#toEarth").html(clickedPlanet.toEarth.length().toFixed(4));const f=decToMinSec(a.ra),g=decToMinSec(a.dec),h=decToMinSec(b.alt),i=decToMinSec(b.az);if($("#RA, #sunRA").html(f.sign+f.deg+"h "+f.min+"&rsquo; "+f.sec.toFixed(1)),$("#dec, #sunDec").html(g.sign+g.deg+"&deg; "+g.min+"&rsquo; "+g.sec.toFixed(1)),$("#alt, #sunAlt").html(h.sign+h.deg+"&deg; "+h.min+"&rsquo; "+h.sec.toFixed(1)),$("#az, #sunAz").html(i.sign+i.deg+"&deg; "+i.min+"&rsquo; "+i.sec.toFixed(1)),riseSet(clickedPlanet),extraData){const a=decToMinSec(b.ha);$("#ha").html(a.deg+"h "+a.min+"&rsquo; "+a.sec.toFixed(1))}if($("#elong").html(c.toFixed(3)),hoverLabel){const a=clickedPlanet.celestialPos.clone().sub(system[hoverLabel[0].id].celestialPos).length(),b=.001>a?(a*AU).toFixed(1)+" km":a.toFixed(3)+" AU";$("#distToActive").html("<br>"+b)}}liveData=!1}if(TWEEN.update(a),0==TWEEN.getAll().length)if(controls.target=""==clickedLabel?new THREE.Vector3:clickedPlanet.celestialPos,following){const a=controls.target,b=lastFollow.sub(a);camera.translateX(b.x),camera.translateY(b.y),camera.translateZ(b.z),lastFollow=a}else lastFollow=controls.target;starfieldObj.position.x=camera.position.x,starfieldObj.position.y=camera.position.y,starfieldObj.position.z=camera.position.z,graticule.position.x=camera.position.x,graticule.position.y=camera.position.y,graticule.position.z=camera.position.z,controls.update(),scene.traverse(darkenNonBloomed),bloomComposer.render(),scene.traverse(restoreMaterial),finalComposer.render();requestAnimationFrame(animate);showSplash||$("#splashScreen").hide(300)}renderEl.addEventListener("webglcontextlost",function(a){a.preventDefault(),cancelAnimationFrame(animationID)},!1);function darkenNonBloomed(a){("undefined"==typeof a.glow||!1==a.glow)&&(materials[a.uuid]=a.material,a.material=darkMaterial)}function restoreMaterial(a){materials[a.uuid]&&(a.material=materials[a.uuid],delete materials[a.uuid])}