document.body.appendChild(renderer.domElement),$("#info").hide();function animate(a){let b=!1,c=1/clock.getDelta();if(fpsBuffer.push(c),4<fpsBuffer.length){let a=0;for(let b=0;b<fpsBuffer.length;b++)a+=fpsBuffer[b];avgFPS=a/fpsBuffer.length,fpsBuffer=[],b=!0}rate=rates[speed]*(fps/c),ephTime+=rate,sun.rotateOnAxis(new THREE.Vector3(0,1,0),sun.thetaDot*rate);let d=ephTimeReadout(ephTime).a;d+=speed>pauseRate-3&&speed<pauseRate+3?ephTimeReadout(ephTime).b:"",d+=speed>pauseRate-2&&speed<pauseRate+2?ephTimeReadout(ephTime).c:"",d+=speed>pauseRate-3&&speed<pauseRate+3?ephTimeReadout(ephTime).d:"",$("#date").html(d),$("#speed").html(rateDesc[speed]),$("#fps").html(avgFPS.toFixed(2)),$("#mjd").html(ephTimeToMJD(ephTime).toFixed(3)),$("#lst").html(localSiderealTime(ephTime).toFixed(3));for(let b=0;b<system.length;b++){1<orbitPoints?system[b].updateOrbit(rate):system[b].update(rate);const a=scene.children[system[b].childId];a.position.x=system[b].celestialPos.x,a.position.y=system[b].celestialPos.y,a.position.z=system[b].celestialPos.z,a.rotateOnAxis(new THREE.Vector3(0,1,0),system[b].thetaDot*rate),system[b].toSun=system[b].celestialPos.length(),system[b].toEarth=system[b].celestialPos.clone().sub(system[earthID].celestialPos);const c=$("#"+b);let e=new THREE.Vector3().setFromMatrixPosition(a.matrixWorld).project(camera);if(e.x=e.x*centerX+centerX,e.y=-1*(e.y*centerY)+centerY,c.length)Math.abs(e.x-centerX)<centerX&&Math.abs(e.y-centerY)<centerY&&1>e.z?c.css({left:e.x+10,top:e.y-5,visibility:"visible"}):c.css({visibility:"hidden"});else{const a=e.distanceTo(mousePos);15>a&&(makeLabel(b),tempLabels.push(b))}if(4<tempLabels.length){const a=$("#"+tempLabels.shift());a.hasClass("active")||a.remove()}}if(graticule.visible){$(".gratLabel").show();for(let a=0;a<gratLabels.length;a++){const b=gratLabels[a].label;let c=new THREE.Vector3(gratLabels[a].x,gratLabels[a].y,gratLabels[a].z).add(camera.position);c.project(camera),c.x=c.x*centerX+centerX,c.y=-1*(c.y*centerY)+centerY,Math.abs(c.x-centerX)<centerX&&Math.abs(c.y-centerY)<centerY&&1>c.z?b.css({left:c.x-20,top:c.y-5,visibility:"visible"}):b.css({visibility:"hidden"})}}else $(".gratLabel").hide();for(let b=0;b<moons.length;b++)paths[moons[b].path].position.x=system[paths[moons[b].path].orbitId].celestialPos.x,paths[moons[b].path].position.y=system[paths[moons[b].path].orbitId].celestialPos.y,paths[moons[b].path].position.z=system[paths[moons[b].path].orbitId].celestialPos.z;if(""!=clickedLabel){const a=vectorToRADec(clickedPlanet.toEarth),c=altAz(a.ra,a.dec),d=180-clickedPlanet.toEarth.angleTo(system[earthID].celestialPos)*toDeg;if(b){if("undefined"==typeof clickedPlanet.orbitId)$("#orbitVel").html(visViva(sunGravConstant,clickedPlanet.toSun,clickedPlanet.semiMajorAxis).toFixed(3));else{const a=clickedPlanet.celestialPos.clone().sub(system[clickedPlanet.orbitId].celestialPos).length();$("#orbitVel").html(visViva(system[clickedPlanet.orbitId].mass*gravConstant,a,clickedPlanet.semiMajorAxis).toFixed(3))}$("#appMag").html(apparentMag(clickedPlanet).toFixed(2)),$("#toSun").html(clickedPlanet.toSun.toFixed(4)),$("#toEarth").html(clickedPlanet.toEarth.length().toFixed(4));const b=decToMinSec(a.ra),e=decToMinSec(a.dec),f=decToMinSec(c.alt),g=decToMinSec(c.az),h=decToMinSec(c.ha);$("#RA").html(b.deg+"h "+b.min+"&rsquo; "+b.sec.toFixed(1)),$("#dec").html(e.deg+"&deg; "+e.min+"&rsquo; "+e.sec.toFixed(1)),$("#alt").html(f.deg+"&deg; "+f.min+"&rsquo; "+f.sec.toFixed(1)),$("#az").html(g.deg+"&deg; "+g.min+"&rsquo; "+g.sec.toFixed(1)),$("#ha").html(h.deg+"h "+h.min+"&rsquo; "+h.sec.toFixed(1)),$("#elong").html(d.toFixed(3))}}if(orbitPoints=1,TWEEN.update(a),0==TWEEN.getAll().length)if(controls.target=""==clickedLabel?new THREE.Vector3:clickedPlanet.celestialPos,following){const a=controls.target,b=lastFollow.sub(a);camera.translateX(b.x),camera.translateY(b.y),camera.translateZ(b.z),lastFollow=a}else lastFollow=controls.target;starfieldObj.position.x=camera.position.x,starfieldObj.position.y=camera.position.y,starfieldObj.position.z=camera.position.z,graticule.position.x=camera.position.x,graticule.position.y=camera.position.y,graticule.position.z=camera.position.z,controls.update(),scene.traverse(darkenNonBloomed),bloomComposer.render(),scene.traverse(restoreMaterial),finalComposer.render(),requestAnimationFrame(animate),showSplash||$("#splashScreen").hide(300)}function darkenNonBloomed(a){("undefined"==typeof a.glow||!1==a.glow)&&(materials[a.uuid]=a.material,a.material=darkMaterial)}function restoreMaterial(a){materials[a.uuid]&&(a.material=materials[a.uuid],delete materials[a.uuid])}