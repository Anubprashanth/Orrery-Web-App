const toRad=Math.PI/180,toDeg=180/Math.PI,celestialXAxis=new THREE.Vector3(1,0,0),celestialZAxis=new THREE.Vector3(0,-1,0),eclInclination=23.43928*toRad+Math.PI,AU=149597870700,gravConstant=66743015e-18,sunGravConstant=132712440042e9,earthRadius=6371e3,months=["January","February","March","April","May","June","July","August","September","October","November","December"],daysPerCent=36525.6363,UnixTimeZeroInMJD=40587,J2KInMJD=51544,DayInMillis=864e5;function plotPoint(a,b,c,d){const e=d&&1==orbitPoints?kepler(b,a):a,f=new THREE.Vector2(c*(Math.cos(e)-b),c*Math.sqrt(1-b*b)*Math.sin(e));return f}function kepler(a,b){let c,d,e=0;do c=e,e=b+a*Math.sin(e),d=e-c;while(Math.abs(d)>2e-8);return e}function celestial(a,b,c,d,e){let f=new THREE.Vector3(d,0,e);return f.applyAxisAngle(celestialZAxis,a).applyAxisAngle(celestialXAxis,c).applyAxisAngle(celestialZAxis,b),f.applyAxisAngle(celestialXAxis,eclInclination)}function planetary(a,b,c,d,e,f,g,h,i){let j=new THREE.Vector3(f,0,g).applyAxisAngle(celestialZAxis,a+b);const k=new THREE.Vector3(0,0,1);return"L"===h?j.applyAxisAngle(k,Math.PI/2-e).applyAxisAngle(celestialZAxis,d):"Q"===h?j.applyAxisAngle(k,Math.PI/2-system[i].axisDec+c).applyAxisAngle(celestialZAxis,system[i].axisRA):"B"===h?j.applyAxisAngle(k,Math.PI/2-system[i].axisDec+c).applyAxisAngle(celestialZAxis,system[i].axisRA):j=celestial(a,b,c,f,g),j}function celestial_textbook(a,b,c,d,e){const f=Math.cos(a),g=Math.sin(a),h=Math.cos(b),i=Math.sin(b),j=Math.cos(c),k=Math.sin(c);return new THREE.Vector3((f*h-g*i*j)*d+(-1*g*h-f*i*j)*e,g*k*d+f*k*e,(f*i+g*h*j)*d+(-1*g*i+f*h*j)*e).applyAxisAngle(new THREE.Vector3(1,0,0),eclInclination)}function reAxis(a,b,c){a.rotateOnWorldAxis(new THREE.Vector3(0,0,1),Math.PI/2-c),a.rotateOnWorldAxis(celestialZAxis,b)}function orbitPath(a){system[a].updateOrbit(0);let b=system[a].celestial;const c=new THREE.BufferGeometry().setFromPoints(b),d=new THREE.LineLoop(c,pathMaterials[system[a].type]);return d.initMaterial=pathMaterials[system[a].type],d.name="path"+a,d}function RADecToVector(a,b){let c=new THREE.Vector3(0,1,0).applyAxisAngle(new THREE.Vector3(1,0,0),(90-b)*toRad);return c.applyAxisAngle(new THREE.Vector3(0,1,0),15*((a+6)%24)*toRad)}function vectorToRADec(a){return{ra:(Math.atan2(a.x,a.z)*toDeg/15+42)%24,dec:a.angleTo(new THREE.Vector3(a.x,0,a.z))*Math.sign(a.y)*toDeg}}function decToMinSec(a){const b=Math.sign(a);a=Math.abs(a);let c=Math.floor(a),d=parseFloat(("0"+Math.floor(60*(a-c))).slice(-2)),e=3600*(a-c-d/60);return 60<=e&&(d++,e-=60),60<=d&&(c++,d-=60),c*=b,{deg:c,min:d,sec:e}}function estRadius(a,b=.15){return r=664.5/Math.sqrt(b)*Math.pow(10,-.2*a)}function visViva(b,c,d){return Math.sqrt(b*(2/c/AU-1/d/AU))/1e3}function displayLatLong(c,a){const b=decToMinSec(c),d=decToMinSec(a);$("#lat").html(Math.abs(b.deg)+"&deg;&nbsp;"+b.min+"&rsquo;&nbsp;"+b.sec.toFixed(1)+"&rdquo;&nbsp;"+(0<latitude?"N":"S,")),$("#long").html(Math.abs(d.deg)+"&deg;&nbsp;"+d.min+"&rsquo;&nbsp;"+d.sec.toFixed(1)+"&rdquo;&nbsp;"+(0<longitude?"E":"W"))}function getLatLong(a){latitude=a.coords.latitude,longitude=a.coords.longitude,displayLatLong(latitude,longitude)}function unixToMJD(a){return a/DayInMillis+UnixTimeZeroInMJD}function MJDToEphTime(a){return(a-J2KInMJD)/daysPerCent}function ephTimeToMJD(a){return a*daysPerCent+J2KInMJD}function MJDtoUnix(a){return new Date((a-UnixTimeZeroInMJD)*DayInMillis)}function ephTimeReadout(a){const c=new Date((a*daysPerCent+J2KInMJD-UnixTimeZeroInMJD)*DayInMillis),d=0<=c.getFullYear()?"":" BC",e=0==c.getHours()%12?12:c.getHours()%12;return{a:months[c.getMonth()]+" "+(" "+c.getDate()).slice(-2)+", "+Math.abs(parseInt(c.getFullYear())).toString()+d,b:"&nbsp;&nbsp;&bull;&nbsp;&nbsp;"+(" "+e).slice(-2)+":"+("0"+c.getMinutes()).slice(-2),c:":"+("0"+c.getSeconds()).slice(-2),d:12>c.getHours()?" AM":" PM"}}function slowTime(){speed=Math.max(speed-1,0)}function speedTime(){speed=Math.min(speed+1,rates.length-1)}function realTime(){ephTime=MJDToEphTime(unixToMJD(Date.now()));for(let a=0;a<system.length;a++)system[a].set(ephTime);speed=8}function setTime(a){ephTime=MJDToEphTime(a),console.log(ephTime);for(let b=0;b<system.length;b++)system[b].set(ephTime);speed=8}function localSiderealTime(a){const b=MJDtoUnix(ephTimeToMJD(a)),c=b.getUTCHours()+b.getUTCMinutes()/60+b.getUTCSeconds()/3600+b.getUTCMilliseconds()/36e5;return lst=(100.46+.985647*a*daysPerCent+longitude+15*c+360)%360}function altAz(a,b){const c=MJDtoUnix(ephTimeToMJD(ephTime)),d=(localSiderealTime(ephTime)-15*a+360)%360*toRad;console.log,b*=toRad;const e=Math.cos(b),f=(90-latitude)*toRad,g=Math.cos(f),h=Math.sin(f),i=Math.cos(d)*e,j=Math.sin(d)*e,k=Math.sin(b),l=Math.atan2(j,i*g-k*h)*toDeg+180,m=Math.asin(i*h+k*g)*toDeg;return{alt:m,az:l,ha:d*toDeg/15}}function lerp(a,b,c){return(b-a)*c+a}function apparentMag(a){const b=a.toEarth.length(),c=a.toSun;let d=(b*b+c*c-1)/(2*b*c);return alpha=1<Math.abs(d)?1:Math.acos(d),a.absoluteMag+5*Math.log10(c*b)-2.5*Math.log10(a.phaseIntegral(alpha))}function BVToRGB(a){let c,d,e,f;return-.4<=a&&0>a?(c=(a+.4)/.4,d=.61+.11*c+.1*c*c):0<=a&&.4>a?(c=a/.4,d=.83+.17*c):.4<=a&&2.1>a&&(c=(a-.4)/1.7,d=1),-.4<=a&&0>a?(c=(a+.4)/.4,e=.7+.07*c+.1*c*c):0<=a&&.4>a?(c=a/.4,e=.87+.11*c):.4<=a&&1.6>a?(c=(a-.4)/1.2,e=.98-.16*c):1.6<=a&&2>a&&(c=(a-1.6)/.4,e=.82-.5*c*c),-.4<=a&&.4>a?(c=(a+.4)/.8,f=1):.4<=a&&1.5>a?(c=(a-.4)/1.1,f=1-.47*c+.1*c*c):1.5<=a&&1.94>a&&(c=(a-1.5)/.44,f=.63-.6*c*c),{r:d,g:e,b:f}}const fps=60,precessFreq=.01,rates=[-1/20/60,-1/100/60,-100/daysPerCent/60,-20/daysPerCent/60,-1/daysPerCent/60,-1/24/daysPerCent/60,-1/86400/daysPerCent/60,0,1/86400/daysPerCent/60,1/24/daysPerCent/60,1/daysPerCent/60,20/daysPerCent/60,100/daysPerCent/60,1/100/60,1/20/60],rateDesc=["-5 years/sec","-1 year/sec","-100 days/sec","-20 days/sec","-1 day/sec","-1 hour/sec","Reversed Time","Paused","Realtime","1 hour/sec","1 day/sec","20 days/sec","100 days/sec","1 year/sec","5 years/sec"],pointCount=360,materials={},pauseRate=7,initialPoint=.01,initialFOV=60,exagScale=5e5,initMinDistance=1,initMaxDistance=100,gratRadius=1e3;let earthID,centerX,centerY,starfieldObj=new THREE.Object3D,graticule=new THREE.Line,lastLoop=Date.now(),fpsBuffer=[],avgFPS=0,orbitPoints=pointCount,speed=8,lastSpeed=speed,rate=rates[speed],datasets=0,flags=0,clickedLabel="",clickedPlanet={},lastClickedPlanet={},system=[],majorBodies=[],moons=[],paths=[],planetMoons=[],contents=[],ephTime=MJDToEphTime(unixToMJD(Date.now())),following=!1,lastFollow=new THREE.Vector3,planetScale={f:1},latitude=51.48,longitude=0,mousePos=new THREE.Vector3(0,0,1),tempLabels=[],gratLabels=[],showSplash=!1;navigator.geolocation.getCurrentPosition(getLatLong);const scene=new THREE.Scene,clock=new THREE.Clock,camera=new THREE.PerspectiveCamera(initialFOV,window.innerWidth/window.innerHeight,1e-6,1e3),renderer=new THREE.WebGLRenderer({antialias:!0,logarithmicDepthBuffer:!0,toneMapping:THREE.ACESFilmicToneMapping}),loader=new THREE.TextureLoader,pathMaterials=[new THREE.LineBasicMaterial({color:13311,linewidth:1,transparent:!0,opacity:.5}),new THREE.LineBasicMaterial({color:13311,linewidth:1,transparent:!0,opacity:.3}),new THREE.LineBasicMaterial({color:13311,linewidth:1,transparent:!0,opacity:.25}),new THREE.LineBasicMaterial({color:13311,linewidth:1,transparent:!0,opacity:.2}),new THREE.LineBasicMaterial({color:13311,linewidth:1,transparent:!0,opacity:.1})],selectedPathMat=new THREE.LineBasicMaterial({color:3368703,linewidth:1.5,transparent:!0,opacity:.7}),defaultMaterial=new THREE.MeshStandardMaterial({map:loader.load("data/1k_eris_fictional.jpg")}),pointMaterial=new THREE.PointsMaterial({color:16777215,alphaMap:loader.load("data/disc.png"),size:initialPoint,transparent:!0}),darkMaterial=new THREE.MeshBasicMaterial({color:0}),transparentMaterial=new THREE.LineBasicMaterial({transparent:!0,opacity:0}),ENTIRE_SCENE=0,BLOOM_SCENE=1,bloomLayer=new THREE.Layers;bloomLayer.set(BLOOM_SCENE);const renderScene=new THREE.RenderPass(scene,camera),bloomPass=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,.4,.85);bloomPass.threshold=.15,bloomPass.strength=7,bloomPass.radius=0;const bloomComposer=new THREE.EffectComposer(renderer);bloomComposer.renderToScreen=!1,bloomComposer.addPass(renderScene),bloomComposer.addPass(bloomPass);const finalPass=new THREE.ShaderPass(new THREE.ShaderMaterial({uniforms:{baseTexture:{value:null},bloomTexture:{value:bloomComposer.renderTarget2.texture}},vertexShader:document.getElementById("vertexshader").textContent,fragmentShader:document.getElementById("fragmentshader").textContent,defines:{}}),"baseTexture");finalPass.needsSwap=!0;const finalComposer=new THREE.EffectComposer(renderer);finalComposer.addPass(renderScene),finalComposer.addPass(finalPass);const ambient=new THREE.AmbientLight(1052706),sunlight=new THREE.PointLight(16777215,1);scene.add(sunlight,ambient),textureEquirec=loader.load("data/starmap_2020_8k.jpg"),textureEquirec.mapping=THREE.EquirectangularReflectionMapping,textureEquirec.encoding=THREE.sRGBEncoding,scene.background=textureEquirec;const geometry=new THREE.IcosahedronGeometry(1e3,2);sphereMaterial=new THREE.MeshBasicMaterial({envMap:textureEquirec}),sphereMesh=new THREE.Mesh(geometry,sphereMaterial),scene.add(sphereMesh);const sunGeometry=new THREE.SphereGeometry(.1,32,32),sunMaterial=new THREE.MeshBasicMaterial({map:loader.load("data/1k_sun.jpg")}),sun=new THREE.Mesh(sunGeometry,sunMaterial);sun.name="Sol",sun.glow=!0,reAxis(sun,63.87*toRad,286.13*toRad),sun.thetaDot=360*daysPerCent/-25.05*toRad,scene.add(sun);const controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enableDamping=!0,controls.dampingFactor=.02,controls.target=new THREE.Vector3,controls.screenSpacePanning=!1,controls.minDistance=initMinDistance,controls.maxDistance=initMaxDistance,controls.maxPolarAngle=Math.PI,camStart=new THREE.Vector3(0,-8,0).applyAxisAngle(celestialXAxis,eclInclination),camera.position.y=camStart.y,camera.position.z=camStart.z,controls.update();function makeBody(a,b,c,d,e,f,g,h,i,j,k){const l="default"==b?defaultMaterial:new THREE.MeshStandardMaterial({map:a.load("data/"+b)}),m=c,n=new THREE.IcosahedronGeometry(m,5),o=new THREE.Mesh(n,l);o.name=d,o.sysId=e;const p=f?parseFloat(f):0;if(0<p){const b=new THREE.RingGeometry(1.01*m,p*m,64),c=a.load("data/"+g),d=new THREE.MeshBasicMaterial({map:c,side:THREE.DoubleSide,transparent:!0,combine:THREE.AddOperation}),e=new THREE.Mesh(b,d);e.rotateX(Math.PI/2),o.attach(e)}return reAxis(o,i,h),o.rotateOnAxis(new THREE.Vector3(0,-1,0),k*ephTime+Math.PI*j),o}function makePoint(a,b){const c=new THREE.BufferGeometry;c.setAttribute("position",new THREE.BufferAttribute(new Float32Array([0,0,0]),3));const d=new THREE.Points(c,pointMaterial);return d.name=a,d.sysId=b,d}function makeLabel(a){$("body").append("<div id='"+a+"' class='label'>"+system[a].displayName+"</div>"),$("#"+a).addClass("tag"+system[a].type).click(function(){$(".label").removeClass("active"),clickTag($(this)[0].id)})}function makeGratLabel(a,b){return $("body").append("<div id='grat"+a+"' class='gratLabel'>"+b+"</div>"),$("#grat"+a)}function makeGraticules(){const a=360,b=12,c=12;let d=[];for(let b,c=0;c<=a;c++)b=new THREE.Vector3(0,gratRadius,0),b.applyAxisAngle(new THREE.Vector3(1,0,0),2*(c*Math.PI)/a),d.push(b);const e=new THREE.BufferGeometry().setFromPoints(d);let f=[];for(let a=0;a<b/2;a++){const c=e.clone();c.rotateY(2*(a*Math.PI)/b),f.push(c)}e.rotateZ(Math.PI/2);for(let a=c/-2;a<c/2;a++){const b=e.clone(),d=Math.cos(a*Math.PI/c),g=Math.sin(a*Math.PI/c)*gratRadius;b.scale(d,1,d),b.translate(0,-g,0),f.push(b)}e.rotateX(eclInclination),f.push(e);const g=THREE.BufferGeometryUtils.mergeBufferGeometries(f),h=new THREE.LineBasicMaterial({color:2236945,linewidth:1});graticule=new THREE.LineLoop(g,h),graticule.name="graticule",scene.add(graticule)}function makeRefPoints(){const a=12,b=12;let c=[0,gratRadius,0],d=["NP"];for(let e=1;e<b;e++){const f=90-15*e;for(let g=0;g<a;g++)x=Math.sin(2*(g*Math.PI)/a)*Math.sin(e*Math.PI/b)*gratRadius,y=Math.cos(e*Math.PI/b)*gratRadius,z=Math.cos(2*(g*Math.PI)/a)*Math.sin(e*Math.PI/b)*gratRadius,c.push(x,y,z),d.push(f+"&deg;/"+2*((g+9)%12)+"h")}c.push(0,-gratRadius,0),d.push("SP");for(let a=0;a<c.length/3;a++){const b=c[3*a],e=c[3*a+1],f=c[3*a+2];text=d[a],gratLabels.push({label:makeGratLabel(a,text),x:b,y:e,z:f})}}$(document).ready(function(){$.ajax({url:"data/planets_1850ad_to_2050ad.csv",async:!0,beforeSend:function(){datasets++},success:function(a){planetData=$.csv.toObjects(a)},dataType:"text",complete:function(){for(let a,b=0;b<planetData.length;b++)a=new Planet(planetData[b]),system.push(a),contents.push(a.displayName);finalize()}}),$.ajax({url:"data/moons.csv",async:!0,beforeSend:function(){datasets++},success:function(a){moonData=$.csv.toObjects(a)},dataType:"text",complete:function(){for(let a,b=0;b<moonData.length;b++)a=new Moon(moonData[b]),system.push(a),moons.push(a),contents.push(a.displayName);finalize()}}),$.ajax({url:"data/asteroids.csv",async:!0,beforeSend:function(){datasets++},success:function(a){asteroidData=$.csv.toObjects(a)},dataType:"text",complete:function(){for(let a,b=0;b<asteroidData.length;b++)a=new Asteroid(asteroidData[b]),system.push(a),contents.push(a.displayName);finalize()}}),$.ajax({url:"data/asteroids2.csv",async:!0,beforeSend:function(){datasets++},success:function(a){asteroidData=$.csv.toObjects(a)},dataType:"text",complete:function(){for(let a,b=0;b<asteroidData.length;b++)a=new Asteroid(asteroidData[b]),system.push(a),contents.push(a.displayName);finalize()}}),$.ajax({url:"data/comets.csv",async:!0,beforeSend:function(){datasets++},success:function(a){cometData=$.csv.toObjects(a)},dataType:"text",complete:function(){for(let a,b=0;b<cometData.length;b++)a=new Comet(cometData[b]),system.push(a),contents.push(a.displayName);finalize()}}),$.ajax({url:"data/stars_7mag.csv",async:!0,success:function(a){starData=$.csv.toObjects(a)},dataType:"text",complete:function(){const a=new THREE.BufferGeometry,b=[],c=[];for(let a=0;a<starData.length;a++){const d=RADecToVector(parseFloat(starData[a].ra),parseFloat(starData[a].dec)).multiplyScalar(900);b.push(d.x,d.y,d.z);const e=Math.pow(10/(parseFloat(starData[a].mag)+10),4),f="undefined"!=typeof starData[a].ci&&0<starData[a].ci.length?parseFloat(starData[a].ci):0,g=BVToRGB(f);c.push(e*g.r,e*g.g,e*g.b)}a.setAttribute("position",new THREE.Float32BufferAttribute(b,3)),a.setAttribute("color",new THREE.Float32BufferAttribute(c,3)),a.computeBoundingSphere();const d=new THREE.PointsMaterial({size:4,vertexColors:!0,alphaMap:loader.load("data/disc.png"),transparent:!0}),e=new THREE.Points(a,d);e.name="starfield",scene.add(e),starfieldObj=e}})});function finalize(){if(flags++,flags==datasets){for(let a=0;a<system.length;a++){system[a].set(ephTime);const b=orbitPath(a);paths.push(b),system[a].sysId=a,system[a].path=paths.length-1;let c;3>system[a].type?(scene.add(b),majorBodies.push(system[a]),c=scene.add(makeBody(loader,system[a].texture,system[a].exagRadius,system[a].name,a,system[a].ringRadius,system[a].ringTexture,system[a].axisDec,system[a].axisRA,system[a].phase,system[a].thetaDot)),makeLabel(a)):c=scene.add(makePoint(system[a].name,a)),system[a].childId=scene.children.length-1}earthID=scene.getObjectByName("Earth").sysId;for(let a=0;a<moons.length;a++){const b=scene.getObjectByName(moons[a].orbiting).sysId,c=scene.children[moons[a].childId].sysId;moons[a].orbitId=b,moons[a].sysId=c,paths[moons[a].path].orbitId=b,2<moons[a].type&&(scene.add(paths[moons[a].path]),makeLabel(moons[a].sysId)),$("#"+c).hide()}makeGraticules(),makeRefPoints(),graticule.visible=!1,animate()}}